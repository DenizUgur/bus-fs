{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import app from \"./core/server\";\nimport * as Sentry from \"@sentry/node\";\n\nconst dev = process.env.NODE_ENV !== \"production\";\n\n//////////////////////////\n//\t\tAPP START\t\t//\n//////////////////////////\nimport sequelize from \"./db\";\nimport routerServe, { isAvailable } from \"./core/serve\";\nimport routerManage from \"./core/manage\";\nimport routerAuth, { passport, isAuthenticated, isTA } from \"./core/auth\";\nimport rateLimiterMiddleware from \"./core/rateLimiter\";\n\n// Initialize Passport\napp.use(passport.initialize());\napp.use((req, res, next) => {\n\tif (req.url.match(/\\/(?:auth|serve|manage)/))\n\t\tpassport.authenticate(\"session\", (err: any, user: any, info: any) => {\n\t\t\tif (err) req.logOut();\n\t\t\tif (!user) return res.redirect(\"/auth/login\");\n\n\t\t\treq.logIn(user, (err) => {\n\t\t\t\tif (err) return next(err);\n\t\t\t\treturn next();\n\t\t\t});\n\t\t})(req, res, next);\n\telse next();\n});\n\napp.use(\"/auth\", routerAuth);\n\nif (dev) {\n\tapp.use(\"/manage\", routerManage);\n\tapp.use(\n\t\t\"/serve\",\n\t\t(req, res, next) => {\n\t\t\treq.user = {\n\t\t\t\tdisplayName: \"Test User\",\n\t\t\t\tsid: \"S000002\",\n\t\t\t};\n\t\t\tnext();\n\t\t},\n\t\trouterServe\n\t);\n} else {\n\tapp.use(\"/manage\", [isAuthenticated, isTA, routerManage]);\n\tapp.use(\"/serve\", [isAuthenticated, rateLimiterMiddleware, routerServe]);\n}\n\napp.get(\"/:type\", (req, res, next) => {\n\tif (!isAvailable(req.params.type)) {\n\t\treturn res.render(\"index\", {\n\t\t\ttitle: \"BUS File Service\",\n\t\t\tmessage: \"This homework is not available yet.\",\n\t\t\tserve: false,\n\t\t});\n\t}\n\treturn res.redirect(`/serve/${req.params.type}`);\n});\n\napp.use(Sentry.Handlers.errorHandler());\n\napp.use((err: any, req: any, res: any, next: any) => {\n\tconsole.error(err);\n\treturn res.render(\"error\", {\n\t\ttitle: \"Error\",\n\t\tmessage: \"500\",\n\t\tsubtitle: \"Internal Server Error\",\n\t\tdescription: `Sorry to see you here, please report us what happend so that we can help you. Error ID: ${res.sentry}`,\n\t\tmail: true,\n\t});\n});\n\nconst PORT = process.env.PORT || 5000;\n\nsequelize.sync({ force: process.env.NODE_ENV != \"production\" }).then(() => {\n\tapp.listen(PORT, () => console.log(`Listening on ${PORT}`));\n});\n"]}