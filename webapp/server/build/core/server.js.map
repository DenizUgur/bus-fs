{"version":3,"file":"server.js","sourceRoot":"","sources":["../../src/core/server.ts"],"names":[],"mappings":"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","sourcesContent":["import express from \"express\";\nimport helmet from \"helmet\";\nimport cors from \"cors\";\nimport bodyParser from \"body-parser\";\nimport path from \"path\";\nimport redis from \"redis\";\nimport methodOverride from \"method-override\";\nimport session from \"express-session\";\nimport cookieParser from \"cookie-parser\";\nimport * as Tracing from \"@sentry/tracing\";\nimport * as Sentry from \"@sentry/node\";\n\nconst dev = process.env.NODE_ENV !== \"production\";\n\nconst app: express.Application = express();\napp.set(\"trust proxy\", 1);\napp.set(\"view engine\", \"pug\");\napp.set(\"views\", path.join(__dirname, \"../views\"));\n\nSentry.init({\n\tdsn: process.env.SENTRY_DSN,\n\tintegrations: [\n\t\tnew Sentry.Integrations.Http({ tracing: true }),\n\t\tnew Tracing.Integrations.Express({ app }),\n\t],\n\ttracesSampleRate: 1.0,\n});\n\napp.use(Sentry.Handlers.requestHandler());\napp.use(Sentry.Handlers.tracingHandler());\napp.use(\"/assets\", express.static(path.join(__dirname, \"../assets\")));\napp.use(\"/\", express.static(path.join(__dirname, \"../../../ui/build/\")));\n\napp.use(\n\thelmet({\n\t\tcontentSecurityPolicy: {\n\t\t\tdirectives: {\n\t\t\t\tdefaultSrc: [\"'self'\", \"fonts.googleapis.com\"],\n\t\t\t\tfontSrc: [\n\t\t\t\t\t\"'self'\",\n\t\t\t\t\t\"fonts.googleapis.com\",\n\t\t\t\t\t\"fonts.gstatic.com\",\n\t\t\t\t],\n\t\t\t\tstyleSrc: [\"'self'\", \"'unsafe-inline'\", \"fonts.googleapis.com\"],\n\t\t\t\tscriptSrc: [\"'self'\", \"'unsafe-inline'\"],\n\t\t\t\tobjectSrc: [\"'none'\"],\n\t\t\t\tupgradeInsecureRequests: [],\n\t\t\t},\n\t\t},\n\t})\n);\napp.use(\n\tcors({\n\t\torigin: \"https://bus-fs.herokuapp.com/\",\n\t\tcredentials: true,\n\t\tallowedHeaders: \"Content-Type, Set-Cookie, Authorization\",\n\t})\n);\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(methodOverride());\napp.use(cookieParser());\n\nif (dev) {\n\tapp.use(\n\t\tsession({\n\t\t\tsecret: process.env.SESSION_KEY || \"\",\n\t\t\tresave: false,\n\t\t\tsaveUninitialized: false,\n\t\t\tcookie: {\n\t\t\t\tsecure: false,\n\t\t\t\tsameSite: \"none\",\n\t\t\t},\n\t\t})\n\t);\n} else {\n\tconst RedisStore = require(\"connect-redis\")(session);\n\tconst redisClient = redis.createClient(process.env.REDIS_URL || \"\");\n\tapp.use(\n\t\tsession({\n\t\t\tstore: new RedisStore({ client: redisClient, ttl: 1000 * 60 * 15 }),\n\t\t\tsecret: process.env.SESSION_KEY || \"\",\n\t\t\tresave: false,\n\t\t\tsaveUninitialized: false,\n\t\t\tcookie: {\n\t\t\t\tsecure: true,\n\t\t\t\tsameSite: \"none\",\n\t\t\t},\n\t\t})\n\t);\n}\n\nexport default app;\n"]}