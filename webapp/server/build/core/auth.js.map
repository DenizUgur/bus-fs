{"version":3,"file":"auth.js","sourceRoot":"","sources":["../../src/core/auth.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response, Router } from \"express\";\nimport { OIDCStrategy } from \"passport-azure-ad\";\nimport { User } from \"../db\";\nconst passport = require(\"passport\");\nconst config = require(\"../config\");\n\nconst router = Router();\n\nconst list = require(\"../../../data/users/students.json\");\nconst listTA = require(\"../../../data/users/TAs.json\");\n\npassport.serializeUser((user: any, done: any) => {\n\tdone(null, user.oid);\n});\n\npassport.deserializeUser(async (oid: any, done: any) => {\n\ttry {\n\t\tawait findByOid(oid, (error: any, user: any) => {\n\t\t\tif (error) {\n\t\t\t\tdone(error, null);\n\t\t\t} else {\n\t\t\t\tdone(null, user.dataValues);\n\t\t\t}\n\t\t});\n\t} catch (error) {\n\t\tdone(error, null);\n\t}\n});\n\nconst findByOid = async (oid: any, fn: any) => {\n\ttry {\n\t\tconst user = await User.findOne({\n\t\t\twhere: { oid },\n\t\t});\n\t\tif (user) return fn(null, user);\n\t\treturn fn(new Error(\"No user\"), null);\n\t} catch (error) {\n\t\treturn fn(error, null);\n\t}\n};\n\nconst getIdByEmail = (email: any) => {\n\tconst TA = listTA.find((el: any) => el.email === email);\n\tconst student = list.find((el: any) => el.email === email);\n\tlet details = {\n\t\tlevel: 0,\n\t\tsid: \"\",\n\t\tenrolled: true,\n\t};\n\n\tif (TA) details.level = 100;\n\tif (TA || student) {\n\t\tdetails.sid = (TA || student).id;\n\t} else {\n\t\tdetails.enrolled = false;\n\t}\n\treturn details;\n};\n\npassport.use(\n\tnew OIDCStrategy(\n\t\t{\n\t\t\tidentityMetadata: config.creds.identityMetadata,\n\t\t\tclientID: config.creds.clientID,\n\t\t\tresponseType: config.creds.responseType,\n\t\t\tresponseMode: config.creds.responseMode,\n\t\t\tredirectUrl: config.creds.redirectUrl,\n\t\t\tallowHttpForRedirectUrl: config.creds.allowHttpForRedirectUrl,\n\t\t\tclientSecret: config.creds.clientSecret,\n\t\t\tvalidateIssuer: config.creds.validateIssuer,\n\t\t\tisB2C: config.creds.isB2C,\n\t\t\tissuer: config.creds.issuer,\n\t\t\tpassReqToCallback: config.creds.passReqToCallback,\n\t\t\tscope: config.creds.scope,\n\t\t\tloggingLevel: config.creds.loggingLevel,\n\t\t\tnonceLifetime: config.creds.nonceLifetime,\n\t\t\tnonceMaxAmount: config.creds.nonceMaxAmount,\n\t\t\tuseCookieInsteadOfSession: config.creds.useCookieInsteadOfSession,\n\t\t\tcookieEncryptionKeys: config.creds.cookieEncryptionKeys,\n\t\t\tclockSkew: config.creds.clockSkew,\n\t\t},\n\t\tasync (\n\t\t\tiss: any,\n\t\t\tsub: any,\n\t\t\tprofile: any,\n\t\t\taccessToken: string,\n\t\t\trefreshToken: string,\n\t\t\tdone: any\n\t\t) => {\n\t\t\tif (!profile.oid) {\n\t\t\t\treturn done(new Error(\"No oid found\"), null);\n\t\t\t}\n\n\t\t\tawait findByOid(profile.oid, async (err: any, user: any) => {\n\t\t\t\tif (err || !user) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst details: any = getIdByEmail(profile._json.email);\n\t\t\t\t\t\tawait User.create({\n\t\t\t\t\t\t\toid: profile.oid,\n\t\t\t\t\t\t\tdisplayName: profile.displayName,\n\t\t\t\t\t\t\temail: profile._json.email,\n\t\t\t\t\t\t\tsid: details.sid,\n\t\t\t\t\t\t\tenrolled: details.enrolled,\n\t\t\t\t\t\t\tlevel: details.level,\n\t\t\t\t\t\t});\n\t\t\t\t\t\treturn done(null, profile);\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\treturn done(error, null);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn done(null, user);\n\t\t\t});\n\t\t}\n\t)\n);\n\nrouter.get(\"/login\", (req, res, next) => {\n\tpassport.authenticate(\"azuread-openidconnect\", {\n\t\tresponse: res,\n\t\tsuccessReturnToOrRedirect: \"/serve\",\n\t\tfailureRedirect: \"/auth/fail\",\n\t})(req, res, next);\n});\n\nrouter.get(\"/openid/return\", (req, res, next) => {\n\tpassport.authenticate(\"azuread-openidconnect\", {\n\t\tresponse: res,\n\t\tsuccessReturnToOrRedirect: \"/serve\",\n\t\tfailureRedirect: \"/auth/fail\",\n\t})(req, res, next);\n});\n\nrouter.post(\"/openid/return\", (req, res, next) => {\n\tpassport.authenticate(\"azuread-openidconnect\", {\n\t\tresponse: res,\n\t\tsuccessReturnToOrRedirect: \"/serve\",\n\t\tfailureRedirect: \"/auth/fail\",\n\t})(req, res, next);\n});\n\nrouter.get(\"/fail\", (req, res) => {\n\tres.render(\"error\", {\n\t\tmessage: \"401\",\n\t\tsubtitle: \"Unauthorized\",\n\t\tdescription:\n\t\t\t\"There has been a problem authenticating your profile. Please log out and try again.\",\n\t\tmail: false,\n\t});\n});\n\nrouter.get(\"/logout\", (req, res) => {\n\treq.session.destroy((err: any) => {\n\t\treq.logOut();\n\t\tres.redirect(\"http://lms.ozyegin.edu.tr\");\n\t});\n});\n\nconst isAuthenticated = (req: Request, res: Response, next: any) => {\n\t// Save returnTo\n\treq.session.returnTo = req.originalUrl;\n\n\tif (req.isAuthenticated()) {\n\t\tif (req.user) {\n\t\t\tif (req.user.enrolled) {\n\t\t\t\treturn next();\n\t\t\t}\n\t\t}\n\t\treturn res.render(\"index\", {\n\t\t\ttitle: \"BUS File Service\",\n\t\t\tmessage: `Sorry, you are not enrolled to this course.`,\n\t\t\tserve: false,\n\t\t});\n\t} else {\n\t\treturn res.redirect(\"/auth/login\");\n\t}\n};\n\nconst isTA = (req: Request, res: Response, next: any) => {\n\t// Save returnTo\n\treq.session.returnTo = req.originalUrl;\n\n\tif (req.isAuthenticated()) {\n\t\tif (req.user) {\n\t\t\tif (req.user.level > 0) {\n\t\t\t\treturn next();\n\t\t\t}\n\t\t}\n\t\treturn res.render(\"index\", {\n\t\t\ttitle: \"BUS File Service\",\n\t\t\tmessage: `Sorry, you are not allowed to access this page.`,\n\t\t\tserve: false,\n\t\t});\n\t} else {\n\t\treturn res.redirect(\"/auth/login\");\n\t}\n};\n\nexport default router;\nexport { passport, isAuthenticated, isTA};\n"]}