{"version":3,"file":"serve.js","sourceRoot":"","sources":["../../src/core/serve.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,qCAAiC;AACjC,gDAAwB;AACxB,iDAAqC;AACrC,4CAAoB;AACpB,8BAA8B;AAE9B,MAAM,MAAM,GAAG,gBAAM,EAAE,CAAC;AACxB,MAAM,SAAS,GAAG,cAAI,CAAC,SAAS,CAAC,oBAAI,CAAC,CAAC;AAEvC,MAAM,WAAW,GAAG,CAAC,IAAY,EAAE,EAAE;IACpC,yBAAyB;IACzB,OAAO,IAAI,IAAI,KAAK,CAAC;AACtB,CAAC,CAAC;AAuDO,kCAAW;AArDpB,MAAM,CAAC,GAAG,CAAC,QAAQ,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;IACjC,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE;QACnB,KAAK,EAAE,kBAAkB;QACzB,OAAO,EAAE,MAAM,GAAG,CAAC,IAAI,CAAC,WAAW,yDAAyD;QAC5F,KAAK,EAAE,IAAI;KACX,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,MAAM,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;IAC5B,gCAAgC;IAChC,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE;QACnB,KAAK,EAAE,kBAAkB;QACzB,OAAO,EAAE,MAAM,GAAG,CAAC,IAAI,CAAC,WAAW,yDAAyD;QAC5F,KAAK,EAAE,IAAI;KACX,CAAC,CAAC;AACJ,CAAC,CAAC,CAAC;AAEH,MAAM,CAAC,GAAG,CAAC,iBAAiB,EAAE,CAAO,GAAG,EAAE,GAAG,EAAE,EAAE;IAChD,gCAAgC;IAChC,MAAM,IAAI,GAAG,KAAK,CAAC;IACnB,MAAM,UAAK,CAAC,MAAM,CAAC;QAClB,EAAE,EAAE,GAAG,CAAC,EAAE;QACV,SAAS,EAAE,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC;QACpC,IAAI,EAAE,GAAG,CAAC,MAAM,CAAC,IAAI,IAAI,KAAK;QAC9B,MAAM,EAAE,KAAK;KACb,CAAC,CAAC;IACH,IAAI,WAAW,CAAC,IAAI,CAAC,EAAE;QACtB,SAAS,CAAC,4BAA4B,IAAI,IAAI,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,EAAE,EAAE,CAAC;aACjE,IAAI,CAAC,GAAG,EAAE;YACV,GAAG,CAAC,QAAQ,CACX,eAAe,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,IAAI,OAAO,EAC1C,GAAG,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,IAAI,OAAO,EAC9B,CAAC,KAAK,EAAE,EAAE;gBACT,IAAI,KAAK;oBAAE,MAAM,KAAK,CAAC;gBACvB,YAAE,CAAC,UAAU,CACZ,eAAe,GAAG,CAAC,IAAI,CAAC,GAAG,IAAI,IAAI,OAAO,CAC1C,CAAC;YACH,CAAC,CACD,CAAC;QACH,CAAC,CAAC;aACD,KAAK,CAAC,CAAC,KAAK,EAAE,EAAE;YAChB,MAAM,KAAK,CAAC;QACb,CAAC,CAAC,CAAC;KACJ;SAAM;QACN,OAAO,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE;YAC1B,KAAK,EAAE,kBAAkB;YACzB,OAAO,EAAE,qCAAqC;YAC9C,KAAK,EAAE,KAAK;SACZ,CAAC,CAAC;KACH;AACF,CAAC,CAAA,CAAC,CAAC;AAEH,kBAAe,MAAM,CAAC","sourcesContent":["import { Router } from \"express\";\nimport util from \"util\";\nimport { exec } from \"child_process\";\nimport fs from \"fs\";\nimport { Stats } from \"../db\";\n\nconst router = Router();\nconst exec_prom = util.promisify(exec);\n\nconst isAvailable = (type: string) => {\n\t//TODO: Make this dynamic\n\treturn type == \"hw5\";\n};\n\nrouter.get(\"/:type\", (req, res) => {\n\tres.render(\"index\", {\n\t\ttitle: \"BUS File Service\",\n\t\tmessage: `Hi ${req.user.displayName}, your file is currently being prepared. Please wait...`,\n\t\tserve: true,\n\t});\n});\n\nrouter.get(\"/\", (req, res) => {\n\t//TODO: Change fallback behavior\n\tres.render(\"index\", {\n\t\ttitle: \"BUS File Service\",\n\t\tmessage: `Hi ${req.user.displayName}, your file is currently being prepared. Please wait...`,\n\t\tserve: true,\n\t});\n});\n\nrouter.get(\"/download/:type\", async (req, res) => {\n\t//TODO: Change fallback behavior\n\tconst type = \"hw5\";\n\tawait Stats.create({\n\t\tip: req.ip,\n\t\tuserAgent: req.headers[\"user-agent\"],\n\t\ttype: req.params.type || \"N/A\",\n\t\torigin: \"GET\",\n\t});\n\tif (isAvailable(type)) {\n\t\texec_prom(`python3 ../worker/app.py ${type} ${req.user.sid || \"\"}`)\n\t\t\t.then(() => {\n\t\t\t\tres.download(\n\t\t\t\t\t`../data/out/${req.user.sid}_${type}.xlsm`,\n\t\t\t\t\t`${req.user.sid}_${type}.xlsm`,\n\t\t\t\t\t(error) => {\n\t\t\t\t\t\tif (error) throw error;\n\t\t\t\t\t\tfs.unlinkSync(\n\t\t\t\t\t\t\t`../data/out/${req.user.sid}_${type}.xlsm`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t})\n\t\t\t.catch((error) => {\n\t\t\t\tthrow error;\n\t\t\t});\n\t} else {\n\t\treturn res.render(\"index\", {\n\t\t\ttitle: \"BUS File Service\",\n\t\t\tmessage: \"This homework is not available yet.\",\n\t\t\tserve: false,\n\t\t});\n\t}\n});\n\nexport default router;\nexport { isAvailable };\n"]}