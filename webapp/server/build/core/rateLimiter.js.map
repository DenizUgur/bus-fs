{"version":3,"file":"rateLimiter.js","sourceRoot":"","sources":["../../src/core/rateLimiter.ts"],"names":[],"mappings":";;;;;AAAA,+CAA8B;AAC9B,iEAA4D;AAE5D,MAAM,IAAI,GAAG;IACZ,SAAS,EAAE,WAAW;IACtB,WAAW,EAAE,YAAS;IACtB,MAAM,EAAE,EAAE;IACV,QAAQ,EAAE,EAAE;IACZ,SAAS,EAAE,WAAW;IACtB,YAAY,EAAE,IAAI;IAClB,qBAAqB,EAAE,IAAI;CAC3B,CAAC;AAEF,MAAM,kBAAkB,GAAG,IAAI,2CAAmB,CAAC,IAAI,CAAC,CAAC;AAEzD,MAAM,qBAAqB,GAAG,CAAC,GAAQ,EAAE,GAAQ,EAAE,IAAS,EAAE,EAAE;IAC/D,kBAAkB;SAChB,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;SAC1B,IAAI,CAAC,CAAC,UAAU,EAAE,EAAE;QACpB,OAAO,IAAI,EAAE,CAAC;IACf,CAAC,CAAC;SACD,KAAK,CAAC,CAAC,UAAU,EAAE,EAAE;QACrB,IAAI,UAAU,YAAY,KAAK,EAAE;YAChC,MAAM,UAAU,CAAC;SACjB;aAAM;YACN,MAAM,OAAO,GAAG,CACf,UAAU,CAAC,UAAU,CAAC,MAAM,EAAE,CAAC,YAAY,CAAC,GAAG,IAAI,CACnD,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YACb,OAAO,GAAG,CAAC,MAAM,CAAC,OAAO,EAAE;gBAC1B,KAAK,EAAE,WAAW;gBAClB,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,mBAAmB;gBAC7B,WAAW,EAAE,eAAe,OAAO,8BAA8B;gBACjE,IAAI,EAAE,IAAI;aACV,CAAC,CAAC;SACH;IACF,CAAC,CAAC,CAAC;AACL,CAAC,CAAC;AAEF,kBAAe,qBAAqB,CAAC","sourcesContent":["import sequelize from \"../db\";\nimport { RateLimiterPostgres } from \"rate-limiter-flexible\";\n\nconst opts = {\n\tkeyPrefix: \"rlDefault\",\n\tstoreClient: sequelize,\n\tpoints: 10, // Number of available points\n\tduration: 60, // Per minute\n\ttableName: \"ratelimit\",\n\ttableCreated: true,\n\tclearExpiredByTimeout: true,\n};\n\nconst rateLimiterDefault = new RateLimiterPostgres(opts);\n\nconst rateLimiterMiddleware = (req: any, res: any, next: any) => {\n\trateLimiterDefault\n\t\t.consume(req.user.email, 1)\n\t\t.then((RLResponse) => {\n\t\t\treturn next();\n\t\t})\n\t\t.catch((RLResponse) => {\n\t\t\tif (RLResponse instanceof Error) {\n\t\t\t\tthrow RLResponse;\n\t\t\t} else {\n\t\t\t\tconst seconds = (\n\t\t\t\t\tparseFloat(RLResponse.toJSON().msBeforeNext) / 1000\n\t\t\t\t).toFixed(0);\n\t\t\t\treturn res.render(\"error\", {\n\t\t\t\t\ttitle: \"429 Error\",\n\t\t\t\t\tmessage: \"429\",\n\t\t\t\t\tsubtitle: \"Too Many Requests\",\n\t\t\t\t\tdescription: `Please wait ${seconds} seconds before trying again`,\n\t\t\t\t\tmail: true,\n\t\t\t\t});\n\t\t\t}\n\t\t});\n};\n\nexport default rateLimiterMiddleware;\n"]}